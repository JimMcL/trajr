---
title: "Animal trajectory analysis with trajr"
author: "Jim McLean"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to trajr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache=TRUE
)
library("plotrix")
library(trajr)
```

## Introduction

Trajr is an R toolkit for statistical analysis of the trajectories of moving animals. The goal of this vignette is to aid biologists who may not have extensive experience with R to become 

### Installation

To use any R package, it is necessary to install and then load/attach it. To install the latest released version of trajr, simply run:
```{r, eval=FALSE}
install_packages("trajr")
```

To install the lastest development version which is available on [GitHub](https://github.com/JimMcL/trajr), run:
```{r, eval=FALSE}
install.packages("devtools")
devtools::install_github("JimMcL/trajr")
```
Once the package has been installed, you must load it, then it's ready for use:
```{r eval=FALSE}
library("trajr)
```
Packages only need to be installed once, but they must be loaded once in every session before they can be used.

Once the trajr package has been installed and loaded, you have access to the set of R functions it provides. All trajr functions (other than the generic function `plot`) start with the prefix `Traj`. Several of the functions provided by trajr do not provide additional analytic functionality, rather they make it easier to work with multiple trajectories. These convenience functions begin with the prefix `Trajs`.

## Trajectories

Trajr works with trajectories. A trajectory is a simplification of a real path travelled by an animal, and is a set of 2-dimensional spatial coordinates with a third temporal dimension. A trajectory can also be thought of as a series of steps, each comprised of a length (L~i~) and a turning angle ($\Delta$~i~). 

```{r fig.cap="Simple random trajectories", fig.height=4, fig.width=6}
# Generate and plot a short random trajectory
set.seed(4)
trj <- TrajGenerate(5, random = TRUE)
plot(trj, main = "Random Trajectory", turning.angles = "random")
```

```{r fig.cap="Simple random and directed trajectories", fig.height=4, fig.width=6}
# Generate and plot a short directed trajectory
set.seed(1)
trj <- TrajGenerate(5, random = FALSE)
plot(trj, main = "Directed walk", turning.angles = "directed")
```

Most trajr functions operate on an R object with class `Trajectory`. The `{TrajFromCoords}` function is used to create a `Trajectory` object from a set of x-y coordinates, with optional times. 


## Analysing trajectory speed

```{r speed, fig.cap="Speed over time, slow intervals (< 90 units/sec) highlighted", fig.width=6, fig.height=4}
plotIntervalsByTime <- function(trj, slowerThan, fasterThan) {
    derivs <- TrajDerivatives(trj)
    speed <- derivs$speed
    plot(x = derivs$speedTimes, y = speed, type = 'l', xlab = 'Time (sec)', ylab = "Speed")
    abline(h = slowerThan, col = "red")
    abline(h = fasterThan, col = "green")
    intervals <- TrajSpeedIntervals(trj, slowerThan = slowerThan, fasterThan = fasterThan)
    rect(intervals$startTime, min(speed), intervals$stopTime, max(speed), col = "#0000FF1E", border = NA)
}

set.seed(1)
trj <- TrajGenerate(100, angularErrorSd = .2)
# smooth as noise is amplified by speed derivation
trj <- TrajSmoothSG(trj, 3, 41)
plotIntervalsByTime(trj, 90, NULL)
```

## Expected results of navigation

Plot the expected results of navigation with and without a compass, based on (Cheung, Zhang, Stricker, & Srinivasan, 2007).

```{r directWalks, fig.cap="Simulated directed journeys", fig.height=5, fig.width=6, cache=TRUE}
simulateJourneys <- function(random, nTrajectories = 10000) {
  trjs <- lapply(1:nTrajectories, function(i) TrajGenerate(n = 500, random = random))
  par(mfrow = c(2, 3), mar = c(4, 4, 3, 1))
  for(step in c(1, 2, 5, 20, 100, 500)) {
    title <- sprintf("%d %s", step, ifelse(step == 1, "step", "steps"))
    plot(t(sapply(trjs, function(t) t[step + 1,c('x', 'y')])), pch  = '.', main = title, asp = 1)
  }
}
simulateJourneys(random = FALSE)
```

```{r randomWalks, fig.cap="Simulated random journeys", fig.height=5, fig.width=6, cache=TRUE}
simulateJourneys(random = TRUE)
```
